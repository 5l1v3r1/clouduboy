<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clouduboy Editor</title>

    <link rel="stylesheet" href="/lib/codemirror/codemirror.css">
    <link rel="stylesheet" href="/lib/codemirror/night.css">

    <link rel="stylesheet" href="/css/style.css">
  </head>

  <body>
    <aside class="toolbar">
      <select name="demo">
      </select>
    </aside>

    <main>
      <form class="editor">
        <textarea id="codeeditor" name="code" contenteditable="true" rows="10" cols="80"></textarea>
        <input id="codeeditor-filename" type="hidden" name="filename" value="" />
      </form>

      <aside class="sidebar">
        <div id="bitmap" class="bitmap">
          <canvas id="framestrip" width="100" height="32" style="background: black;image-rendering: -moz-crisp-edges;image-rendering: crisp-edges;"></canvas>
        </div>
        <div id="logs" class="logs"></div>
      </aside>
    </main>

    <script src="/lib/codemirror/codemirror.js"></script>
    <script src="/lib/codemirror/clike.js"></script>
    <script src="/lib/codemirror/javascript.js"></script>

    <script src="/js/util.js"></script>

    <script src="/lib/pif/lib.js"></script>
    <script src="/lib/microcanvas/microcanvas.js"></script>
    <script>(function(){
      'use strict'

      const examples = {
        'Invader, C-style': `
          PROGMEM const unsigned char invader[] = { /*9x8*/ 0x70, 0x38, 0x6a, 0x3c, 0x78, 0x3c, 0x6a, 0x38, 0x70 }
        `,

        'Invader, ASCII': `
          ! invader 9x8
          .........
          ..#...#..
          ...#.#...
          .#######.
          ##.###.##
          #########
          #.#.#.#.#
          .........
        `,

        'Bats, multiframe, C-style': `
        PROGMEM const unsigned char bats[] = { /*16x6x2*/
          0x01, 0x0f, 0x0e, 0x1c, 0x38, 0x3c, 0x1b, 0x3e,
          0x3e, 0x1b, 0x3c, 0x38, 0x1c, 0x0e, 0x0f, 0x01,
          0x1c, 0x0e, 0x0c, 0x07, 0x0e, 0x0c, 0x1b, 0x3e,
          0x3e, 0x1b, 0x0c, 0x0e, 0x07, 0x0c, 0x0e, 0x1c,
        };
        `,

        'Invader, multiframe, ASCII': `
        ! invader 9x8x3
        .........
        ..#...#..
        ...#.#...
        .#######.
        ##.###.##
        #########
        #.#.#.#.#
        .........

        .........
        ...#.#...
        ...#.#...
        .#######.
        ###.##.##
        #########
        .#.#.#.#.
        .........

        .........
        ...#.#...
        ...#.#...
        .#######.
        ##.##.###
        #########
        .#.#.#.#.
        .........
`,
      'invader, 2-bit palette, ASCII': `
      ! invader 9x8@2
      .........
      ..3...3..
      ...3.3...
      .#######.
      ##2###2##
      #########
      #.#.#.#.#
      .........
`,
      }
      document.querySelector('select').innerHTML = (
        Object.keys(examples).map(l => `<option>${l}</option>`).join('')
      )

      const editor = CodeMirror.fromTextArea(
        document.getElementById("codeeditor"),
        {
          theme: "night",
          tabsize: 2,
          lineNumbers: true,
          lineWrapping: true
        }
      )

      const framestrip = document.getElementById('framestrip').getContext('2d')

      const dropdown = document.querySelector('select')
      dropdown.addEventListener('change', _ => load(dropdown.value))

      editor.on('change', update)

      document.querySelector('canvas').classList.add('microcanvas');

      const mc = new MicroCanvas(framestrip)
      load(dropdown.value)

      window.editor = editor
      window.examples = examples

      window.currentFrame = 0
      window.currentSprite
      setInterval(_ => {
        framestrip.clearRect(0,0, framestrip.width,framestrip.height)
        framestrip.drawImage(window.currentSprite[window.currentFrame % (window.currentSprite.length||1)], 0,0)

        window.currentFrame++
      }, 700)

      function load(label) {
        let val = trimmed(examples[label]) || Object.values(examples)[0]

        editor.setValue(val)
      }

      function update() {
        parse(trimmed(editor.getValue()))
      }
      function parse(str) {
        sidebar.clearLog()

        const sprite = mc.loadSprite(str)
        const px = sprite.pixeldata

        console.log(px.id, sprite)

        sidebar.log(px.id||'?')
        sidebar.log(`${px.w}Ã—${px.h} pixels`)
        if (px.frames) sidebar.log(px.frames+' frames')
        if (px.palette>1) sidebar.log(px.palette+' bit color')

        window.currentSprite = sprite
        window.currentFrame = 0
      }

      function trimmed(str) {
        let s = (typeof str==='object' && str[0]) ? str[0] : str

        if (!s) return ''
        return s.split(/\n/).map(e => e.trim()).join('\n').trim()
      }
    })()</script>
  </body>
</html>
