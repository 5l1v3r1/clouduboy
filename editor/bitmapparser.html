<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clouduboy Editor</title>

    <link rel="stylesheet" href="/lib/codemirror/codemirror.css">
    <link rel="stylesheet" href="/lib/codemirror/night.css">

    <link rel="stylesheet" href="/css/style.css">
  </head>

  <body>
    <aside class="toolbar">
      <select name="demo">
      </select>
    </aside>

    <main>
      <form class="editor">
        <textarea id="codeeditor" name="code" contenteditable="true" rows="10" cols="80"></textarea>
        <input id="codeeditor-filename" type="hidden" name="filename" value="" />
      </form>

      <aside class="sidebar">
        <div id="bitmap" class="bitmap">
          <canvas id="framestrip" width="100" height="32" style="background: black;image-rendering: -moz-crisp-edges;image-rendering: crisp-edges;"></canvas>
        </div>
        <div id="logs" class="logs"></div>
      </aside>
    </main>

    <script src="/lib/codemirror/codemirror.js"></script>
    <script src="/lib/codemirror/clike.js"></script>
    <script src="/lib/codemirror/javascript.js"></script>

    <script src="/js/util.js"></script>

    <script src="/lib/pif/lib.js"></script>
    <script src="/lib/microcanvas/microcanvas.js"></script>
    <script>(function(){
      'use strict'

      const examples = {
        'Invader, C-style': `
          PROGMEM const unsigned char invader[] = { /*9x8*/ 0x70, 0x38, 0x6a, 0x3c, 0x78, 0x3c, 0x6a, 0x38, 0x70 }
        `,

        'Invader, ASCII': `
          ! invader 9x8
          .........
          ..#...#..
          ...#.#...
          .#######.
          ##.###.##
          #########
          #.#.#.#.#
          .........
        `,

        'Bats, multiframe, C-style': `
        PROGMEM const unsigned char bats[] = { /*16x6x2*/
          0x01, 0x0f, 0x0e, 0x1c, 0x38, 0x3c, 0x1b, 0x3e,
          0x3e, 0x1b, 0x3c, 0x38, 0x1c, 0x0e, 0x0f, 0x01,
          0x1c, 0x0e, 0x0c, 0x07, 0x0e, 0x0c, 0x1b, 0x3e,
          0x3e, 0x1b, 0x0c, 0x0e, 0x07, 0x0c, 0x0e, 0x1c,
        };
        `,

        'Bats, multiframe, ASCII': `
          ! bats 16x6x2
          ##....#..#....##
          .##...####...##.
          .###.#.##.#.###.
          .##############.
          ...##########...
          ....##.##.##....
          ...#..#..#..#...
          .#.##.####.##.#.
          ######.##.######
          ###.########.###
          #.....####.....#
          .......##.......
        `,

        'Invader, multiframe, ASCII': `
        ! invader 9x8x3
        .........
        ..#...#..
        ...#.#...
        .#######.
        ##.###.##
        #########
        #.#.#.#.#
        .........

        .........
        ...#.#...
        ...#.#...
        .#######.
        ###.##.##
        #########
        .#.#.#.#.
        .........

        .........
        ...#.#...
        ...#.#...
        .#######.
        ##.##.###
        #########
        .#.#.#.#.
        .........
`,
      'Invader, 2-bit palette, ASCII': `
      ! invader 9x8@2
      .........
      ..3...3..
      ...3.3...
      .#######.
      ##2###2##
      #########
      #.#.#.#.#
      .........
`,
      'Sonic, 3-bit palette, ASCII': `
      ! sonic 16x16@#00a,#000,#55f,#a55,#fa5,#fff,#aaa
      ....#####....#..
      ..##333#3####3..
      ....#3#4#333#3..
      ....###54#333#..
      ...###454#333#..
      ..##3#45336333#.
      .##33333376633#.
      #33333333766232.
      ######333766232.
      ..####3337662222
      ...####344662422
      ..#3###455544522
      .#3####45555554.
      .#3#####455554..
      ##########44....
      ......####22....
`,
      'Grayscale blob, ASCII': `
      ! grayscale 5x5@4
      .....
      ..#..
      ..#..
      ..#..
      .....

      .....
      ..#..
      .###.
      ..#..
      .....

      ..#..
      .###.
      .###.
      .###.
      ..#..

      .###.
      #####
      #####
      #####
      .###.
`,
      'Sonic grayscale, C-style': `
      PROGMEM const unsigned char grayscale_sonic[] = {
        /*16x16@4*/
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0xe0, 0xc0, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x07, 0x07, 0x00, 0x00, 0x00, 0x00,

        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38,
        0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x18, 0x3b, 0x38, 0x30, 0x30, 0x18, 0x00, 0x00,

        0x00, 0x80, 0x80, 0xc0, 0xe2, 0xc6, 0xf2, 0xc4,
        0xfa, 0x24, 0x1c, 0x3c, 0x78, 0xe6, 0x00, 0x00,
        0x00, 0x00, 0x30, 0x08, 0x00, 0x00, 0x03, 0x1f,
        0x27, 0x04, 0x40, 0x48, 0x08, 0x25, 0x10, 0x00,

        0x80, 0x40, 0x62, 0x32, 0x1d, 0x39, 0x0d, 0x03,
        0x05, 0x1a, 0x02, 0x02, 0x06, 0x19, 0x60, 0x00,
        0x41, 0x71, 0x4b, 0x77, 0x7f, 0x7f, 0xfc, 0xe0,
        0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
      }`,
      }
      document.querySelector('select').innerHTML = (
        Object.keys(examples).map(l => `<option>${l}</option>`).join('')
      )

      const editor = CodeMirror.fromTextArea(
        document.getElementById("codeeditor"),
        {
          theme: "night",
          tabsize: 2,
          lineNumbers: true,
          lineWrapping: true
        }
      )

      const framestrip = document.getElementById('framestrip').getContext('2d')

      const dropdown = document.querySelector('select')
      dropdown.addEventListener('change', _ => load(dropdown.value))

      editor.on('change', update)

      document.querySelector('canvas').classList.add('microcanvas');

      const mc = new MicroCanvas(framestrip)
      load(dropdown.value)

      window.editor = editor
      window.examples = examples

      window.currentFrame = 0
      window.currentSprite
      setInterval(_ => {
        let s = window.currentSprite, px = s.pixeldata
        const fr = window.currentFrame
        let frame = fr % (s.length||1)

        // Color sprites
        if (px.bpp > 1) {
          // Multicolor sprite
          if (px.palette && px.palette.length > 2) {
            if (fr % 6 === 0) {
              // Display with original color palette
              window.currentSprite = s = mc.loadSprite(s.pixeldata.$host || s.pixeldata)

            // Display with greyscale palette
          } else if (fr % 6 === 3){
              window.currentSprite = s = mc.loadSprite(s.pixeldata.grayscale())
            }

            framestrip.clearRect(0,0, framestrip.width,framestrip.height)
            framestrip.drawImage(s[frame], 0,0)


          // Greyscale C-sprite
          } else if (px.palette && px.palette.length == 2) {
            // Draw frames on top of each other
            window.currentSprite = s = mc.loadSprite(px.colors( [ [0,0,0,0], [255,255,255,64] ] ))

            framestrip.globalCompositeOperation = 'lighter';

            // Only clear for first frame
            if (fr % 4 === 0) {
              framestrip.clearRect(0,0, framestrip.width,framestrip.height)
            }

            if (frame>2) framestrip.drawImage(s[3], 0,0)
            if (frame>1) framestrip.drawImage(s[2], 0,0)
            if (frame>0) framestrip.drawImage(s[1], 0,0)
            framestrip.drawImage(s[0], 0,0)
          }

        } else {
          framestrip.clearRect(0,0, framestrip.width,framestrip.height)
          framestrip.drawImage(s[frame], 0,0)
        }

        window.currentFrame++
      }, 700)

      function load(label) {
        let val = trimmed(examples[label]) || Object.values(examples)[0]

        editor.setValue(val)
      }

      function update() {
        parse(trimmed(editor.getValue()))
      }
      function parse(str) {
        sidebar.clearLog()

        const sprite = mc.loadSprite(str)
        const px = sprite.pixeldata

        console.log(px.id, sprite)

        sidebar.log(px.id||'?')
        sidebar.log(`${px.w}Ã—${px.h} pixels`)
        if (px.frames) sidebar.log(px.frames+' frames')
        if (px.palette>1) sidebar.log(px.bpp+' bits per pixel ('+(1<<(px.bpp-1))+' colors)')

        window.currentSprite = sprite
        window.currentFrame = 0
      }

      function trimmed(str) {
        let s = (typeof str==='object' && str[0]) ? str[0] : str

        if (!s) return ''
        return s.split(/\n/).map(e => e.trim()).join('\n').trim()
      }
    })()</script>
  </body>
</html>
