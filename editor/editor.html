<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clouduboy Editor</title>

    <link rel="stylesheet" href="/lib/codemirror/codemirror.css">
    <link rel="stylesheet" href="/lib/codemirror/night.css">

    <link rel="stylesheet" href="/css/style.css">
  </head>

  <body>
    <form>
      <textarea id="codeeditor" name="code" contenteditable="true" rows="10" cols="80">loading...</textarea>
    </form>
    <div id="servermsgs" class="servermsgs"></div>

    <script src="/lib/codemirror/codemirror.js"></script>
    <script src="/lib/codemirror/clike.js"></script>

    <script>
      var editor;
      var lastBuild;

      // Set up CodeMirror for editing
      editor = CodeMirror.fromTextArea(
        document.getElementById("codeeditor"),
        {
          theme: "night",
          tabsize: 2,
          lineNumbers: true,
          lineWrapping: true
        }
      );

      // Fetch last build source
      fetch("/src/build").then(function(r) {
        return r.text();

      // Update editor to last build source
      }).then(function(body) {
        editor.setValue(body);

      }).catch(function(e) { console.error(e); });


      function throttle(callback, delay) {
        var lastRequest = null;
        var lastArgs = [];
        var timeout;

        var fulfill = function() {
          lastRequest = null;
          timeout = null;
          callback.call(...lastArgs);
        }

        return function(...args) {
          lastArgs = args;

          // Restart throttle
          if (timeout) clearTimeout(timeout);
          timeout = setTimeout(fulfill, delay);
          lastRequest = Date.now();
        }
      }

      // Editor form
      var form = document.querySelector('form');

      // Build form document and check for errors, size etc.
      function checkBuild (editor, change) {
        console.log(change);

        fetch('/build', {
          method: 'post',
          body: new FormData(form)

        }).then(function(r) {
          return r.json();

        }).then(function(res) {
          lastBuild = res;

          if (lastBuild.error) {
            var msgs = document.getElementById("servermsgs")
              msgs.classList.add("error");
              msgs.textContent = lastBuild.error;

              if (lastBuild.compiler['build.ino'] && lastBuild.compiler['build.ino'].length > 0) {
                lastBuild.compiler['build.ino'].forEach(function(err) {
                  var msg = document.createElement("div");
                  var icon = msg.appendChild(document.createElement("span"));
                  icon.innerHTML = "!!";
                  icon.className = "lint-error-icon";
                  msg.appendChild(document.createTextNode(err.reason));
                  msg.className = "lint-error";
                  editor.addLineWidget(err.line - 1, msg, {coverGutter: false, noHScroll: true});
                });
              }
          }
        }).catch(function(e) {
          console.error("Error checking build: ", e);
        });
      }

      // Create throttled version to avoid stressing the server & save bandwidth
      throttleCheckBuild = throttle(checkBuild, 1000);

      // Check builds if document changed
      editor.on("changes", throttleCheckBuild);

      var sprite, marker;
      sprite = document.createElement('span');
      sprite.className = "sprite";

      marker = editor.markText({ line: 11, ch: 37 },{ line: 11, ch: 139 }, { replacedWith: sprite, clearOnEnter: true });
      sprite.ondblclick = function() { marker.clear(); };
    </script>
  </body>
</html>
